// chatbot.js - Single file to include on every page
// Just add: <script src="chatbot.js"></script> before closing </body> tag

(function() {
  'use strict';
  
  // Prevent multiple instances
  if (window.chatbotLoaded) return;
  window.chatbotLoaded = true;

  // Create and inject CSS
  const css = `
    #chatbot-icon {
      position: fixed !important;
      bottom: 30px !important;
      right: 30px !important;
      width: 60px !important;
      height: 60px !important;
      cursor: pointer !important;
      z-index: 999999 !important;
      transition: transform 0.3s ease !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2) !important;
    }
    #chatbot-icon:hover { transform: scale(1.1) !important; }
    .astronaut {
      position: absolute !important;
      left: 50% !important;
      top: 50% !important;
      width: 60px !important;
      height: 80px !important;
      transform: translate(-50%, -50%) !important;
      animation: float 4s ease-in-out infinite !important;
    }
    .astronaut-helmet {
      position: absolute !important;
      width: 40px !important;
      height: 40px !important;
      background: linear-gradient(145deg, #ffffff, #e6e6e6) !important;
      border-radius: 50% !important;
      top: 0 !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      box-shadow: inset -3px -3px 8px rgba(0,0,0,0.2), 2px 2px 4px rgba(255,255,255,0.1) !important;
    }
    .helmet-glass {
      position: absolute !important;
      width: 32px !important;
      height: 20px !important;
      background: linear-gradient(135deg, rgba(0,255,255,0.2), rgba(0,0,255,0.1)) !important;
      border-radius: 50% 50% 45% 45% !important;
      top: 10px !important;
      left: 4px !important;
      overflow: hidden !important;
    }
    .helmet-inner-glass {
      position: absolute !important;
      inset: 2px !important;
      background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 50%, rgba(0,0,0,0.1) 100%) !important;
      border-radius: inherit !important;
      animation: glass-shine 3s ease-in-out infinite !important;
    }
    .antenna {
      position: absolute !important;
      width: 3px !important;
      height: 12px !important;
      background: #ccc !important;
      top: -8px !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
    }
    .antenna::after {
      content: "" !important;
      position: absolute !important;
      width: 5px !important;
      height: 5px !important;
      background: #ff3333 !important;
      border-radius: 50% !important;
      top: -2px !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      animation: blink 1s ease-in-out infinite !important;
    }
    .astronaut-body {
      position: absolute !important;
      width: 35px !important;
      height: 50px !important;
      background: linear-gradient(145deg, #ffffff, #f0f0f0) !important;
      border-radius: 25px !important;
      top: 35px !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      box-shadow: inset -4px -4px 8px rgba(0,0,0,0.2), 2px 2px 4px rgba(255,255,255,0.1) !important;
    }
    #chat-window {
      position: fixed !important;
      bottom: 100px !important;
      right: 30px !important;
      width: 380px !important;
      height: 500px !important;
      background: rgba(255, 255, 255, 0.98) !important;
      backdrop-filter: blur(20px) !important;
      border-radius: 24px !important;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25) !important;
      display: none !important;
      flex-direction: column !important;
      overflow: hidden !important;
      z-index: 999998 !important;
      border: 1px solid rgba(255, 140, 0, 0.2) !important;
      transition: all 0.3s ease !important;
      max-height: calc(100vh - 150px) !important;
      max-width: calc(100vw - 60px) !important;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
    }
    #chat-window.fullscreen {
      width: calc(100vw - 60px) !important;
      height: calc(100vh - 150px) !important;
      bottom: 100px !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      max-width: 1000px !important;
      right: auto !important;
    }
    #chat-header {
      background: linear-gradient(135deg, #FF8C00 0%, #ff9f1a 100%) !important;
      color: white !important;
      padding: 20px 24px !important;
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
      box-shadow: 0 4px 12px rgba(255, 140, 0, 0.2) !important;
    }
    .header-left {
      display: flex !important;
      align-items: center !important;
      gap: 12px !important;
    }
    .status-indicator {
      width: 8px !important;
      height: 8px !important;
      background: #00ff88 !important;
      border-radius: 50% !important;
      box-shadow: 0 0 8px #00ff88 !important;
      animation: pulse 2s ease-in-out infinite !important;
    }
    .header-title {
      font-size: 18px !important;
      font-weight: 600 !important;
      margin: 0 !important;
    }
    .header-subtitle {
      font-size: 12px !important;
      opacity: 0.9 !important;
      font-weight: normal !important;
      margin: 0 !important;
    }
    .header-controls {
      display: flex !important;
      gap: 8px !important;
      align-items: center !important;
    }
    .header-btn {
      background: rgba(255, 255, 255, 0.2) !important;
      border: none !important;
      color: white !important;
      width: 36px !important;
      height: 36px !important;
      border-radius: 50% !important;
      cursor: pointer !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      font-size: 16px !important;
      font-weight: bold !important;
      transition: all 0.3s ease !important;
    }
    .header-btn:hover {
      background: rgba(255, 255, 255, 0.3) !important;
      transform: scale(1.1) !important;
    }
    #chat-body {
      flex: 1 !important;
      overflow-y: auto !important;
      padding: 24px !important;
      display: flex !important;
      flex-direction: column !important;
      gap: 16px !important;
      background: linear-gradient(180deg, rgba(255, 140, 0, 0.02) 0%, transparent 100%) !important;
    }
    .chat-message {
      max-width: 85% !important;
      padding: 16px 20px !important;
      border-radius: 20px !important;
      font-size: 15px !important;
      line-height: 1.4 !important;
      position: relative !important;
      animation: messageSlide 0.3s ease-out !important;
      margin: 0 !important;
    }
    .chat-message.bot {
      background: linear-gradient(135deg, rgba(255, 140, 0, 0.1) 0%, rgba(255, 140, 0, 0.05) 100%) !important;
      border: 1px solid rgba(255, 140, 0, 0.2) !important;
      align-self: flex-start !important;
      border-radius: 20px 20px 20px 5px !important;
    }
    .chat-message.user {
      background: linear-gradient(135deg, #FF8C00 0%, #ff9f1a 100%) !important;
      color: white !important;
      align-self: flex-end !important;
      border-radius: 20px 20px 5px 20px !important;
      box-shadow: 0 4px 12px rgba(255, 140, 0, 0.3) !important;
    }
    .message-time {
      font-size: 11px !important;
      opacity: 0.6 !important;
      margin-top: 4px !important;
    }
    #chat-input-area {
      display: flex !important;
      padding: 20px 24px !important;
      background: rgba(255, 255, 255, 0.8) !important;
      backdrop-filter: blur(10px) !important;
      border-top: 1px solid rgba(255, 140, 0, 0.1) !important;
      gap: 12px !important;
      align-items: center !important;
    }
    #chat-input {
      flex: 1 !important;
      padding: 16px 20px !important;
      border-radius: 25px !important;
      border: 2px solid rgba(255, 140, 0, 0.2) !important;
      outline: none !important;
      font-size: 15px !important;
      background: white !important;
      transition: border-color 0.3s ease, box-shadow 0.3s ease !important;
      font-family: inherit !important;
    }
    #chat-input:focus {
      border-color: #FF8C00 !important;
      box-shadow: 0 0 0 4px rgba(255, 140, 0, 0.1) !important;
    }
    .input-btn {
      width: 50px !important;
      height: 50px !important;
      border: none !important;
      border-radius: 50% !important;
      cursor: pointer !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      font-size: 18px !important;
      transition: all 0.3s ease !important;
    }
    #voice-btn {
      background: linear-gradient(135deg, rgba(255, 140, 0, 0.1) 0%, rgba(255, 140, 0, 0.05) 100%) !important;
      color: #FF8C00 !important;
      border: 2px solid rgba(255, 140, 0, 0.3) !important;
    }
    #voice-btn:hover, #voice-btn.recording {
      background: linear-gradient(135deg, #FF8C00 0%, #ff9f1a 100%) !important;
      color: white !important;
      transform: scale(1.05) !important;
    }
    #send-btn {
      background: linear-gradient(135deg, #FF8C00 0%, #ff9f1a 100%) !important;
      color: white !important;
      box-shadow: 0 4px 12px rgba(255, 140, 0, 0.3) !important;
    }
    #send-btn:hover {
      transform: scale(1.05) !important;
      box-shadow: 0 6px 16px rgba(255, 140, 0, 0.4) !important;
    }
    @keyframes float {
      0%, 100% { transform: translate(-50%, -50%) translateY(-5px) rotate(-2deg); }
      50% { transform: translate(-50%, -50%) translateY(5px) rotate(2deg); }
    }
    @keyframes glass-shine {
      0%, 100% { opacity: 0.3; transform: translateX(-100%) rotate(-45deg); }
      50% { opacity: 0.8; transform: translateX(100%) rotate(-45deg); }
    }
    @keyframes blink {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.7; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.3); }
    }
    @keyframes messageSlide {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 480px) {
      #chat-window {
        width: calc(100vw - 20px) !important;
        height: calc(100vh - 120px) !important;
        bottom: 80px !important;
        right: 10px !important;
        left: 10px !important;
        border-radius: 16px !important;
      }
      #chat-window.fullscreen {
        width: calc(100vw - 20px) !important;
        left: 10px !important;
        transform: none !important;
      }
      #chatbot-icon {
        bottom: 20px !important;
        right: 20px !important;
        width: 55px !important;
        height: 55px !important;
      }
    }
  `;

  // Inject CSS
  const style = document.createElement('style');
  style.textContent = css;
  document.head.appendChild(style);

  // Wait for DOM to be ready
  function initializeChatbot() {
    // Create chatbot icon
    const chatbotIcon = document.createElement('div');
    chatbotIcon.id = 'chatbot-icon';
    chatbotIcon.innerHTML = `
      <div class="astronaut">
        <div class="astronaut-helmet">
          <div class="helmet-glass">
            <div class="helmet-inner-glass"></div>
          </div>
          <div class="antenna"></div>
        </div>
        <div class="astronaut-body"></div>
      </div>
    `;
    document.body.appendChild(chatbotIcon);

    // Create chat window
    const chatWindow = document.createElement('div');
    chatWindow.id = 'chat-window';
    
    function getCurrentTime() {
      return new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
    
    chatWindow.innerHTML = `
      <div id="chat-header">
        <div class="header-left">
          <div class="status-indicator"></div>
          <div>
            <div class="header-title">University Assistant</div>
            <div class="header-subtitle">Online ‚Ä¢ Ready to help</div>
          </div>
        </div>
        <div class="header-controls">
          <button class="header-btn" id="fullscreen-btn" title="Fullscreen">‚õ∂</button>
          <button class="header-btn" id="close-chat" title="Close Chat">‚úï</button>
        </div>
      </div>
      <div id="chat-body">
        <div class="chat-message bot">
          üëã Welcome to Excellence University!
          <div class="message-time">${getCurrentTime()}</div>
        </div>
        <div class="chat-message bot">
          I'm your AI assistant, ready to help with admissions, programs, campus life, and more. What would you like to know?
          <div class="message-time">${getCurrentTime()}</div>
        </div>
      </div>
      <div id="chat-input-area">
        <button class="input-btn" id="voice-btn" title="Voice Input">
          <span class="voice-icon">üéôÔ∏è</span>
        </button>
        <input type="text" id="chat-input" placeholder="Ask me anything about the university..." autocomplete="off"/>
        <button class="input-btn" id="send-btn" title="Send Message">‚û§</button>
      </div>
    `;
    document.body.appendChild(chatWindow);

    // Get elements
    const chatBody = chatWindow.querySelector('#chat-body');
    const chatInput = chatWindow.querySelector('#chat-input');
    const sendBtn = chatWindow.querySelector('#send-btn');
    const closeBtn = chatWindow.querySelector('#close-chat');
    const voiceBtn = chatWindow.querySelector('#voice-btn');
    const fullscreenBtn = chatWindow.querySelector('#fullscreen-btn');
    const voiceIcon = voiceBtn.querySelector('.voice-icon');

    let isFullscreen = false;

    // Toggle chat window
    chatbotIcon.addEventListener('click', () => {
      const isOpen = chatWindow.style.display === 'flex';
      if (isOpen) {
        chatWindow.style.display = 'none';
      } else {
        chatWindow.style.display = 'flex';
        chatInput.focus();
      }
    });

    // Close chat
    closeBtn.addEventListener('click', () => {
      chatWindow.style.display = 'none';
      if (isFullscreen) {
        chatWindow.classList.remove('fullscreen');
        isFullscreen = false;
        fullscreenBtn.textContent = '‚õ∂';
      }
    });

    // Fullscreen toggle
    fullscreenBtn.addEventListener('click', () => {
      isFullscreen = !isFullscreen;
      if (isFullscreen) {
        chatWindow.classList.add('fullscreen');
        fullscreenBtn.textContent = '‚õ∂';
      } else {
        chatWindow.classList.remove('fullscreen');
        fullscreenBtn.textContent = '‚õ∂';
      }
    });

    // Send message function
    function sendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;

      sendBtn.disabled = true;

      // User message
      const userMsg = document.createElement('div');
      userMsg.className = 'chat-message user';
      userMsg.innerHTML = `
        ${text}
        <div class="message-time">${getCurrentTime()}</div>
      `;
      chatBody.appendChild(userMsg);
      chatBody.scrollTop = chatBody.scrollHeight;
      chatInput.value = '';

      // Bot response simulation
      setTimeout(() => {
        const responses = [
          "Thanks for your question! I'd be happy to help you with information about our university programs.",
          "That's a great question! Our admissions team can provide more detailed information about that topic.",
          "I understand you're interested in learning more. Let me connect you with the right resources.",
          "Our university offers many opportunities in that area. Would you like me to provide more specific details?"
        ];
        
        const botMsg = document.createElement('div');
        botMsg.className = 'chat-message bot';
        botMsg.innerHTML = `
          ${responses[Math.floor(Math.random() * responses.length)]}
          <div class="message-time">${getCurrentTime()}</div>
        `;
        chatBody.appendChild(botMsg);
        chatBody.scrollTop = chatBody.scrollHeight;
        
        sendBtn.disabled = false;
      }, 1500);
    }

    // Event listeners
    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });

    // Voice input
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = false;

      voiceBtn.addEventListener('click', () => {
        if (voiceBtn.classList.contains('recording')) {
          recognition.stop();
          return;
        }
        
        recognition.start();
        voiceBtn.classList.add('recording');
        voiceIcon.textContent = 'üî¥';
        chatInput.placeholder = 'Listening...';
      });

      recognition.addEventListener('result', (event) => {
        const transcript = event.results[0][0].transcript;
        chatInput.value = transcript;
        voiceBtn.classList.remove('recording');
        voiceIcon.textContent = 'üéôÔ∏è';
        chatInput.placeholder = 'Ask me anything about the university...';
        chatInput.focus();
      });

      recognition.addEventListener('end', () => {
        voiceBtn.classList.remove('recording');
        voiceIcon.textContent = 'üéôÔ∏è';
        chatInput.placeholder = 'Ask me anything about the university...';
      });
    } else {
      voiceBtn.style.display = 'none';
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeChatbot);
  } else {
    initializeChatbot();
  }
})();